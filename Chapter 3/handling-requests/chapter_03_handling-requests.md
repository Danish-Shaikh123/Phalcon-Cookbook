
## Handling a request along multiple controllers

Being able to easily assign URL paths to server side controller logic is a powerful capability.  To improve on this we will be introducing the ability to have requests forwarded from one controller to another controller and so on.  This framework design is known as HMVC (Hierarchical Model View Controller) and this recipe will demonstrate how to work with the "H" part of Phalcon.

#### Getting Ready...

To use this recipe you will need to have a project skeleton with a configured Phalcon bootstraper, Phalcon\Mvc\Router and three Phalcon\Mvc\Controler.  In our example we will use a project scaffold generated by **Phalcon Developer Tools**.

For testing the recipe results you need to have a web server installed and configured for handling requests to your application. Your application must be able to take requests, and additionally, there must be such necessary components as Controllers, Views, and a bootstrap-file.

A database is not required for this recipe.

#### How to do it...
Follow these steps to complete this recipeâ€¦

1) First of all, we need to have an application which we will experiment with. If you already have such an application, you can skip this step. Otherwise create a simple application: `phalcon project  handling-requests simple`.

2) Now point the web browser at the root directory of the project. There should be a page with "Congratulations! ....".  If we see the *Volt directory can't be written* error message then permissions of the directory `app/cache` needs to be changed to allow the web server to write to it.

3) Create three Phalcon\Mvc\Controller classes in your `app/controllers` directory:

`IndexController.php`
```php
<?php

class IndexController extends \Phalcon\Mvc\Controller
{
    // Uses 'views/index/index.volt' for output
    public indexAction()
    {
    }
}
```

`StartController.php`
```php
<?php

class StartController extends \Phalcon\Mvc\Controller
{

    public function indexAction()
    {
        return $this->dispatcher->forward([
            'controller' => 'handle',
            'action'     => 'forward'
        ]);
    }

    public function redirectAction()
    {
        return $this->dispatcher->forward([
            'controller' => 'handle',
            'action'     => 'redirect'
        ]);
    }
}
```

`HandleController.php`
```php
<?php

class HandleController extends \Phalcon\Mvc\Controller
{

    public function forwardAction()
    {
        return $this->dispatcher->forward([
            'controller' => 'index',
            'action'     => 'index'
        ]);
    }

    public function redirectAction()
    {
        return $this->response->redirect('https://www.packtpub.com/', true);
    }
}
```

4) First we will test out a double forward by setting our browser path `start`.  The StartController will forward to the HandleController which will then forward back to the main IndexController and so the home view will be displayed.  Next setting the URL path to `start/redirect` will forward to the HandleController but this time we will redirect the browser to the Packt website.


#### How it works...

Before we begin to explore the actual use of the controller forwarding technique it is important to have a good understanding of the differences between a redirect and a forward operation.

A redirect operation can be described in terms of an externally accessible URL either on the same website or a different one:
```php
<?php

// Local relative URL path
return $response->redirect('controllerName/actionName/?abc=123');

// External absolute path
return $response->redirect('http://our-other-website.com/important_page', true);

```

and a forward operation is always purely describing an internal operation:
```php
<?php

return $dispatcher->forward([
    'controller' => 'index',
    'action'     => 'show404'
])
```

However, this understanding does not capture the essence of how very different the two operations are.  The redirect operation will send a HTTP header to the user's browser to tell it to change its current path to the new one and to begin a completely new request cycle at the new path while the forward operation will continue the logic handling operation at the new controller-action location.  At this point the user's browser has not yet been informed of any differences in internal server operation.

So with a single request it is possible to forward across multiple controller-actions and then to finally finish with a browser redirect.  Notice that redirects are performed with the \Phalcon\Http\Response class while forwards are performed with \Phalcon\Mvc\Dispatcher.
