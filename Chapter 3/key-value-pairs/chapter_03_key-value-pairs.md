
## Using flexible key-value action parameter pairs

Sometimes in our controllers we would like to be able to receive named parameters from the route instead of receiving the normal number parameters supplied when using the default routing pattern.  This is a good strategy for separating the implementation of the routing system from the logical implementation in the controller.  For example in a controller accessing the "0" route parameter instead of "name" makes the controller logic brittle because changes to the ordering and structure of the route could cause the parameter ordering to change.  Additionally accessing a parameter by a string name is much more clear than by an integer.

#### Getting Ready...

To use this recipe you will need to have a project skeleton with a configured Phalcon bootstraper, \Phalcon\Mvc\Router and at least one \Phalcon\Mvc\Controler.  In our example we will use a project scaffold generated by **Phalcon Developer Tools**.

For testing the recipe results you need to have a web server installed and configured for handling requests to your application. Your application must be able to take requests, and additionally, there must be such necessary components as Controllers, Views, and a bootstrap-file.

A database is not required for this recipe.

#### How to do it...
Follow these steps to complete this recipeâ€¦

1) First of all, we need to have an application which we will experiment with. If you already have such an application, you can skip this step. Create a simple application: `phalcon project key-value-pairs simple`.

2) Now point the web browser at the root directory of the project. There should be a page with "Congratulations! ....".  If we see the *Volt directory can't be written* error message then permissions of the directory `app/cache` needs to be changed to allow the web server to write to it.

3) Create two \Phalcon\Mvc\Controller classes in your `app/controllers` directory:

`KeyValueControllerBase.php`
```php
<?php

class KeyValueControllerBase extends \Phalcon\Mvc\Controller
{

    public function beforeExecuteRoute($dispatcher)
    {
        $keyParams = [];
        $params = $dispatcher->getParams();
        foreach ($params as $number => $value) {
            if ($number & 1) {
                $keyParams[$params[$number - 1]] = $value;
            }
        }
        $dispatcher->setParams($keyParams);
    }
}
```

`BlogController.php`
```php
<?php

class BlogController extends KeyValueControllerBase
{
    public function searchAction()
    {
        $params = $this->dispatcher->getParams();

        if (sizeof($params) === 0) {
            return 'Sorry: You must add at least one search criteria.';
        }

        // One of the key value pairs must be 'publisher/packt'
        if (!isset($params['publisher']) || strtolower($params['publisher']) !== 'packt') {
            return 'Sorry: Packt is the only publisher in this database.';
        }

        $output = "Searching By: <br><br>\n";
        foreach ($params as $key => $value) {
            $output .= "$key: $value<br>\n";
        }

        return $output;
    }
}
```

4) We will now test that our controllers are working by going to the URL path `blog/search`.  There should be a message stating "Sorry: You must add at least one search criteria".  So now we can try out our key-value pair system by changing the URL path to `blog/search/publisher/packt`.  In our searchAction function we have made it so that one of the key-value pairs must be `publisher/packt` or otherwise a warning message is given.  So that is working try adding new key-value pairs to the URL to see the search criteria printed out.

#### How it Works...

The Phalcon dispatch loop controls the execution of code by triggering a series of events in a specific order.  There are two main ways to plug into these events and the first is to attach a listener directly to the dispatcher itself and the other is for classes like a \Phalcon\Mvc\Controller to have a function named after one of the triggered events.  In our case we are using the later method in KeyValueControllerBase with the beforeExecuteRoute function.

The specific ordering of the events triggered in the dispatch cycle are as follows:

* beforeDispatchLoop
* beforeDispatch
* beforeExecuteRoute
* initialize
* afterExecuteRoute
* beforeNotFoundAction
* beforeException
* afterDispatch
* afterDispatchLoop

You may read about the dispatching loop in detail at:   https://docs.phalconphp.com/en/latest/reference/dispatching.html

So now lets get back to the two new classes that we added.  The KeyValueControllerBase is a base class for providing our key-value parameter functionality to any controller.  Simply have a controller inherit from it and it will be setup to use key-value pairs.  Specifically the logic for performing this calculation is brief and in time a developer could enhance it to provide additional capabilities.

Then in BlogController (or any other derived class of KeyValueControllerBase) we can call `$this->dispatcher->getParams()` to get a normal PHP associative array of the key-value pairs.  Additionally it is possible to use the Dispatcher method `getParam` to check values of a single key-value.
